window.libpannellum=function(a,b){'use strict';function c(c){function j(c,a){return 1==c.level&&1!=a.level?-1:1==a.level&&1!=c.level?1:a.timestamp-c.timestamp}function k(c,a){return c.level==a.level?c.diff-a.diff:c.level-a.level}function l(){if(!N.drawInProgress){N.drawInProgress=!0,O.clear(O.COLOR_BUFFER_BIT);for(var a=0;a<N.currentNodes.length;a++)1<N.currentNodes[a].textureLoaded&&(O.bindBuffer(O.ARRAY_BUFFER,Z),O.bufferData(O.ARRAY_BUFFER,new Float32Array(N.currentNodes[a].vertices),O.STATIC_DRAW),O.vertexAttribPointer(N.vertPosLocation,3,O.FLOAT,!1,0,0),O.bindBuffer(O.ARRAY_BUFFER,$),O.vertexAttribPointer(N.texCoordLocation,2,O.FLOAT,!1,0,0),O.bindTexture(O.TEXTURE_2D,N.currentNodes[a].texture),O.drawElements(O.TRIANGLES,6,O.UNSIGNED_SHORT,0));N.drawInProgress=!1}}function m(a,b,c,d,e,f){this.vertices=a,this.side=b,this.level=c,this.x=d,this.y=e,this.path=f.replace('%s',b).replace('%l',c).replace('%x',d).replace('%y',e)}function i(a,b,c,d,e){if(A(a,b.vertices)){var g=b.vertices,h=g[0]+g[3]+g[6]+g[9],l=g[1]+g[4]+g[7]+g[10],n=g[2]+g[5]+g[8]+g[11],o=F(h*h+l*l+n*n),p=H(n/o),q=G(l,h),r=q-d;r+=r>K?-2*K:r<-K?2*K:0,r=Math.abs(r),b.diff=E(I(c)*I(p)+J(c)*J(p)*J(r));for(var s=!1,t=0;t<N.nodeCache.length;t++)if(N.nodeCache[t].path==b.path){s=!0,N.nodeCache[t].timestamp=N.nodeCacheTimestamp++,N.nodeCache[t].diff=b.diff,N.currentNodes.push(N.nodeCache[t]);break}if(s||(b.timestamp=N.nodeCacheTimestamp++,N.currentNodes.push(b),N.nodeCache.push(b)),b.level<N.level){var u=V.cubeResolution*B(2,b.level-V.maxLevel),v=Math.ceil(u*V.invTileResolution)-1,w=2*(u%V.tileResolution),x=2*u%V.tileResolution;0===x&&(x=V.tileResolution),0==w&&(w=2*V.tileResolution);var y=.5;(b.x==v||b.y==v)&&(y=1-V.tileResolution/(V.tileResolution+x));var z,C,D=1-y,L=[],M=y,O=y,P=y,Q=D,R=D,S=D;x<V.tileResolution&&(b.x==v&&b.y!=v?(O=.5,R=.5,('d'==b.side||'u'==b.side)&&(P=.5,S=.5)):b.x!=v&&b.y==v&&(M=.5,Q=.5,('l'==b.side||'r'==b.side)&&(P=.5,S=.5))),w<=V.tileResolution&&(b.x==v&&(M=0,Q=1,('l'==b.side||'r'==b.side)&&(P=0,S=1)),b.y==v&&(O=0,R=1,('d'==b.side||'u'==b.side)&&(P=0,S=1))),z=[g[0],g[1],g[2],g[0]*M+g[3]*Q,g[1]*y+g[4]*D,g[2]*P+g[5]*S,g[0]*M+g[6]*Q,g[1]*O+g[7]*R,g[2]*P+g[8]*S,g[0]*y+g[9]*D,g[1]*O+g[10]*R,g[2]*P+g[11]*S],C=new m(z,b.side,b.level+1,2*b.x,2*b.y,V.fullpath),L.push(C),b.x==v&&w<=V.tileResolution||(z=[g[0]*M+g[3]*Q,g[1]*y+g[4]*D,g[2]*P+g[5]*S,g[3],g[4],g[5],g[3]*y+g[6]*D,g[4]*O+g[7]*R,g[5]*P+g[8]*S,g[0]*M+g[6]*Q,g[1]*O+g[7]*R,g[2]*P+g[8]*S],C=new m(z,b.side,b.level+1,2*b.x+1,2*b.y,V.fullpath),L.push(C)),b.x==v&&w<=V.tileResolution||b.y==v&&w<=V.tileResolution||(z=[g[0]*M+g[6]*Q,g[1]*O+g[7]*R,g[2]*P+g[8]*S,g[3]*y+g[6]*D,g[4]*O+g[7]*R,g[5]*P+g[8]*S,g[6],g[7],g[8],g[9]*M+g[6]*Q,g[10]*y+g[7]*D,g[11]*P+g[8]*S],C=new m(z,b.side,b.level+1,2*b.x+1,2*b.y+1,V.fullpath),L.push(C)),b.y==v&&w<=V.tileResolution||(z=[g[0]*y+g[9]*D,g[1]*O+g[10]*R,g[2]*P+g[11]*S,g[0]*M+g[6]*Q,g[1]*O+g[7]*R,g[2]*P+g[8]*S,g[9]*M+g[6]*Q,g[10]*y+g[7]*D,g[11]*P+g[8]*S,g[9],g[10],g[11]],C=new m(z,b.side,b.level+1,2*b.x,2*b.y+1,V.fullpath),L.push(C));for(var T=0;T<L.length;T++)i(a,L[T],c,d,e)}}}function n(){return[-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1]}function o(){return[1,0,0,0,1,0,0,0,1]}function p(a,b,d){var e=I(b),f=J(b);return'x'==d?[a[0],f*a[1]+e*a[2],f*a[2]-e*a[1],a[3],f*a[4]+e*a[5],f*a[5]-e*a[4],a[6],f*a[7]+e*a[8],f*a[8]-e*a[7]]:'y'==d?[f*a[0]-e*a[2],a[1],f*a[2]+e*a[0],f*a[3]-e*a[5],a[4],f*a[5]+e*a[3],f*a[6]-e*a[8],a[7],f*a[8]+e*a[6]]:'z'==d?[f*a[0]+e*a[1],f*a[1]-e*a[0],a[2],f*a[3]+e*a[4],f*a[4]-e*a[3],a[5],f*a[6]+e*a[7],f*a[7]-e*a[6],a[8]]:void 0}function q(a){return[a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1]}function r(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]}function t(a,b,c,d){var e=2*C(D(a/2)*O.drawingBufferHeight/O.drawingBufferWidth),g=1/D(e/2);return[g/b,0,0,0,0,g,0,0,0,0,(d+c)/(c-d),2*d*c/(c-d),0,0,-1,0]}function s(a,b){O.bindTexture(O.TEXTURE_2D,b),O.texImage2D(O.TEXTURE_2D,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,a),O.texParameteri(O.TEXTURE_2D,O.TEXTURE_MAG_FILTER,O.LINEAR),O.texParameteri(O.TEXTURE_2D,O.TEXTURE_MIN_FILTER,O.LINEAR),O.texParameteri(O.TEXTURE_2D,O.TEXTURE_WRAP_S,O.CLAMP_TO_EDGE),O.texParameteri(O.TEXTURE_2D,O.TEXTURE_WRAP_T,O.CLAMP_TO_EDGE),O.bindTexture(O.TEXTURE_2D,null)}function u(a){ca(a,encodeURI(a.path+'.'+V.extension),function(b,c){a.texture=b,a.textureLoaded=c?2:1},aa.crossOrigin)}function v(a){for(var b=1;b<V.maxLevel&&O.drawingBufferWidth>.707*(V.tileResolution*B(2,b-1)*D(a/2));)b++;N.level=b}function w(a,b){return[a[0]*b[0],a[0]*b[1],a[0]*b[2],0,a[5]*b[4],a[5]*b[5],a[5]*b[6],0,a[10]*b[8],a[10]*b[9],a[10]*b[10],a[11],-b[8],-b[9],-b[10],0]}function x(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[4]*b[0]+a[5]*b[1]+a[6]*b[2],a[11]+a[8]*b[0]+a[9]*b[1]+a[10]*b[2],1/(a[12]*b[0]+a[13]*b[1]+a[14]*b[2])]}function y(a,b){var c=x(a,b),d=c[0]*c[3],e=c[1]*c[3],f=c[2]*c[3],g=[0,0,0];return-1>d&&(g[0]=-1),1<d&&(g[0]=1),-1>e&&(g[1]=-1),1<e&&(g[1]=1),(-1>f||1<f)&&(g[2]=1),g}function A(a,b){var c=y(a,b.slice(0,3)),d=y(a,b.slice(3,6)),e=y(a,b.slice(6,9)),f=y(a,b.slice(9,12)),g=c[0]+d[0]+e[0]+f[0];if(-4==g||4==g)return!1;var h=c[1]+d[1]+e[1]+f[1];if(-4==h||4==h)return!1;var i=c[2]+d[2]+e[2]+f[2];return 4!=i}function z(){var a=Math.round;console.log('Reducing canvas size due to error 1286!'),M.width=a(M.width/2),M.height=a(M.height/2)}var B=Math.pow,C=Math.atan,D=Math.tan,E=Math.acos,F=Math.sqrt,G=Math.atan2,H=Math.asin,I=Math.sin,J=Math.cos,K=Math.PI,L=Math.max,M=b.createElement('canvas');M.style.width=M.style.height='100%',c.appendChild(M);var N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa;this.init=function(a,j,k,l,m,o,p,q){function r(a){if(w){var b=4*(a*a),c=new Uint8ClampedArray(b),d=q.backgroundColor?q.backgroundColor:[0,0,0];d[0]*=255,d[1]*=255,d[2]*=255;for(var e=0;e<b;e++)c[e++]=d[0],c[e++]=d[1],c[e++]=d[2];var f=new ImageData(c,a,a);for(u=0;6>u;u++)0==V[u].width&&(V[u]=f)}}if(void 0===j&&(j='equirectangular'),'equirectangular'!=j&&'cubemap'!=j&&'multires'!=j)throw console.log('Error: invalid image type specified!'),{type:'config error'};if(W=j,V=a,X=k,aa=q||{},N){if(P&&(O.detachShader(N,P),O.deleteShader(P)),Q&&(O.detachShader(N,Q),O.deleteShader(Q)),O.bindBuffer(O.ARRAY_BUFFER,null),O.bindBuffer(O.ELEMENT_ARRAY_BUFFER,null),N.texture&&O.deleteTexture(N.texture),N.nodeCache)for(var t=0;t<N.nodeCache.length;t++)O.deleteTexture(N.nodeCache[t].texture);O.deleteProgram(N),N=void 0}U=void 0;var u,v,w=!1;if('cubemap'==W)for(u=0;6>u;u++)0<V[u].width?(void 0===v&&(v=V[u].width),v!=V[u].width&&console.log('Cube faces have inconsistent widths: '+v+' vs. '+V[u].width)):w=!0;if('cubemap'==W&&0!=(v&v-1)&&(navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 9_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 10_/)||navigator.userAgent.match(/Trident.*rv[ :]*11\./))||(!O&&(O=M.getContext('experimental-webgl',{alpha:!1,depth:!1})),O&&1286==O.getError()&&z()),!O&&('multires'==W&&V.hasOwnProperty('fallbackPath')||'cubemap'==W)&&('WebkitAppearance'in b.documentElement.style||navigator.userAgent.match(/Trident.*rv[ :]*11\./)||-1!==navigator.appVersion.indexOf('MSIE 10'))){S&&c.removeChild(S),S=b.createElement('div'),S.className='pnlm-world';var x=V.basePath?V.basePath+V.fallbackPath:V.fallbackPath;var y=['f','r','b','l','u','d'],A=0,B=function(){var a=b.createElement('canvas');a.className='pnlm-face pnlm-'+y[this.side]+'face',S.appendChild(a);var c=a.getContext('2d');a.style.width=this.width+4+'px',a.style.height=this.height+4+'px',a.width=this.width+4,a.height=this.height+4,c.drawImage(this,2,2);var d,e,f=c.getImageData(0,0,a.width,a.height),g=f.data;for(d=2;d<a.width-2;d++)for(e=0;4>e;e++)g[4*(d+a.width)+e]=g[4*(d+2*a.width)+e],g[4*(d+a.width*(a.height-2))+e]=g[4*(d+a.width*(a.height-3))+e];for(d=2;d<a.height-2;d++)for(e=0;4>e;e++)g[4*(d*a.width+1)+e]=g[4*(d*a.width+2)+e],g[4*((d+1)*a.width-2)+e]=g[4*((d+1)*a.width-3)+e];for(e=0;4>e;e++)g[4*(a.width+1)+e]=g[4*(2*a.width+2)+e],g[4*(2*a.width-2)+e]=g[4*(3*a.width-3)+e],g[4*(a.width*(a.height-2)+1)+e]=g[4*(a.width*(a.height-3)+2)+e],g[4*(a.width*(a.height-1)-2)+e]=g[4*(a.width*(a.height-2)-3)+e];for(d=1;d<a.width-1;d++)for(e=0;4>e;e++)g[4*d+e]=g[4*(d+a.width)+e],g[4*(d+a.width*(a.height-1))+e]=g[4*(d+a.width*(a.height-2))+e];for(d=1;d<a.height-1;d++)for(e=0;4>e;e++)g[4*(d*a.width)+e]=g[4*(d*a.width+1)+e],g[4*((d+1)*a.width-1)+e]=g[4*((d+1)*a.width-2)+e];for(e=0;4>e;e++)g[e]=g[4*(a.width+1)+e],g[4*(a.width-1)+e]=g[4*(2*a.width-2)+e],g[4*(a.width*(a.height-1))+e]=g[4*(a.width*(a.height-2)+1)+e],g[4*(a.width*a.height-1)+e]=g[4*(a.width*(a.height-1)-2)+e];c.putImageData(f,0,0),C.call(this)},C=function(){0<this.width?(void 0===R&&(R=this.width),R!=this.width&&console.log('Fallback faces have inconsistent widths: '+R+' vs. '+this.width)):w=!0,A++,6==A&&(R=this.width,c.appendChild(S),p())};for(w=!1,u=0;6>u;u++){var D=new Image;D.crossOrigin=aa.crossOrigin?aa.crossOrigin:'anonymous',D.side=u,D.onload=B,D.onerror=C,D.src='multires'==W?encodeURI(x.replace('%s',y[u])+'.'+V.extension):encodeURI(V[u].src)}return void r(R)}if(!O)throw console.log('Error: no WebGL support detected!'),{type:'no webgl'};'cubemap'==W&&r(v),V.fullpath=V.basePath?V.basePath+V.path:V.path,V.invTileResolution=1/V.tileResolution;var E=n();for(T=[],u=0;6>u;u++)T[u]=E.slice(12*u,12*u+12),E=n();var F=0,G=0;if('equirectangular'==W?(F=L(V.width,V.height),G=O.getParameter(O.MAX_TEXTURE_SIZE)):'cubemap'==W&&(F=v,G=O.getParameter(O.MAX_CUBE_MAP_TEXTURE_SIZE)),F>G)throw console.log('Error: The image is too big; it\'s '+F+'px wide, but this device\'s maximum supported size is '+G+'px.'),{type:'webgl size error',width:F,maxWidth:G};void 0!==q&&(void 0!==q.horizonPitch||void 0!==q.horizonRoll)&&(U=[null==q.horizonPitch?0:q.horizonPitch,null==q.horizonRoll?0:q.horizonRoll]);var H=O.TEXTURE_2D;O.viewport(0,0,O.drawingBufferWidth,O.drawingBufferHeight),P=O.createShader(O.VERTEX_SHADER);var I=d;'multires'==W&&(I=e),O.shaderSource(P,I),O.compileShader(P),Q=O.createShader(O.FRAGMENT_SHADER);var J=g;'cubemap'==W?(H=O.TEXTURE_CUBE_MAP,J=f):'multires'==W&&(J=h),O.shaderSource(Q,J),O.compileShader(Q),N=O.createProgram(),O.attachShader(N,P),O.attachShader(N,Q),O.linkProgram(N),O.getShaderParameter(P,O.COMPILE_STATUS)||console.log(O.getShaderInfoLog(P)),O.getShaderParameter(Q,O.COMPILE_STATUS)||console.log(O.getShaderInfoLog(Q)),O.getProgramParameter(N,O.LINK_STATUS)||console.log(O.getProgramInfoLog(N)),O.useProgram(N),N.drawInProgress=!1;var ba=q.backgroundColor?q.backgroundColor:[0,0,0];O.clearColor(ba[0],ba[1],ba[2],1),O.clear(O.COLOR_BUFFER_BIT),N.texCoordLocation=O.getAttribLocation(N,'a_texCoord'),O.enableVertexAttribArray(N.texCoordLocation),'multires'==W?(N.vertPosLocation=O.getAttribLocation(N,'a_vertCoord'),O.enableVertexAttribArray(N.vertPosLocation),!Z&&(Z=O.createBuffer()),!$&&($=O.createBuffer()),!_&&(_=O.createBuffer()),O.bindBuffer(O.ARRAY_BUFFER,$),O.bufferData(O.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),O.STATIC_DRAW),O.bindBuffer(O.ELEMENT_ARRAY_BUFFER,_),O.bufferData(O.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),O.STATIC_DRAW),N.perspUniform=O.getUniformLocation(N,'u_perspMatrix'),N.cubeUniform=O.getUniformLocation(N,'u_cubeMatrix'),N.level=-1,N.currentNodes=[],N.nodeCache=[],N.nodeCacheTimestamp=0):(!Y&&(Y=O.createBuffer()),O.bindBuffer(O.ARRAY_BUFFER,Y),O.bufferData(O.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),O.STATIC_DRAW),O.vertexAttribPointer(N.texCoordLocation,2,O.FLOAT,!1,0,0),N.aspectRatio=O.getUniformLocation(N,'u_aspectRatio'),O.uniform1f(N.aspectRatio,O.drawingBufferWidth/O.drawingBufferHeight),N.psi=O.getUniformLocation(N,'u_psi'),N.theta=O.getUniformLocation(N,'u_theta'),N.f=O.getUniformLocation(N,'u_f'),N.h=O.getUniformLocation(N,'u_h'),N.v=O.getUniformLocation(N,'u_v'),N.vo=O.getUniformLocation(N,'u_vo'),N.rot=O.getUniformLocation(N,'u_rot'),O.uniform1f(N.h,l/(2*K)),O.uniform1f(N.v,m/K),O.uniform1f(N.vo,2*(o/K)),'equirectangular'==W&&(N.backgroundColor=O.getUniformLocation(N,'u_backgroundColor'),O.uniform4fv(N.backgroundColor,ba.concat([1]))),N.texture=O.createTexture(),O.bindTexture(H,N.texture),'cubemap'==W?(O.texImage2D(O.TEXTURE_CUBE_MAP_POSITIVE_X,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[1]),O.texImage2D(O.TEXTURE_CUBE_MAP_NEGATIVE_X,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[3]),O.texImage2D(O.TEXTURE_CUBE_MAP_POSITIVE_Y,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[4]),O.texImage2D(O.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[5]),O.texImage2D(O.TEXTURE_CUBE_MAP_POSITIVE_Z,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[0]),O.texImage2D(O.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V[2])):O.texImage2D(H,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V),O.texParameteri(H,O.TEXTURE_WRAP_S,O.CLAMP_TO_EDGE),O.texParameteri(H,O.TEXTURE_WRAP_T,O.CLAMP_TO_EDGE),O.texParameteri(H,O.TEXTURE_MIN_FILTER,O.LINEAR),O.texParameteri(H,O.TEXTURE_MAG_FILTER,O.LINEAR));var ca=O.getError();if(0!==ca)throw console.log('Error: Something went wrong with WebGL!',ca),{type:'webgl error'};p()},this.destroy=function(){if(void 0!==c&&(void 0!==M&&c.contains(M)&&c.removeChild(M),void 0!==S&&c.contains(S)&&c.removeChild(S)),O){var a=O.getExtension('WEBGL_lose_context');a&&a.loseContext()}},this.resize=function(){var b=a.devicePixelRatio||1;M.width=M.clientWidth*b,M.height=M.clientHeight*b,O&&(1286==O.getError()&&z(),O.viewport(0,0,O.drawingBufferWidth,O.drawingBufferHeight),'multires'!=W&&O.uniform1f(N.aspectRatio,M.clientWidth/M.clientHeight))},this.resize(),this.setPose=function(a,b){U=[a,b]},this.render=function(a,b,c,d){var e,f,g,h=Math.min,n=0;if(void 0===d&&(d={}),d.roll&&(n=d.roll),void 0!==U){var A=U[0],B=U[1],P=a,Q=b,Y=J(B)*I(a)*I(A)+J(a)*(J(A)*J(b)+I(B)*I(A)*I(b)),x=-I(a)*I(B)+J(a)*J(B)*I(b),y=J(B)*J(A)*I(a)+J(a)*(-J(b)*I(A)+J(A)*I(B)*I(b));a=H(L(h(y,1),-1)),b=G(x,Y);var z=[J(P)*(I(B)*I(A)*J(Q)-J(A)*I(Q)),J(P)*J(B)*J(Q),J(P)*(J(A)*I(B)*J(Q)+I(Q)*I(A))],Z=[-J(a)*I(b),J(a)*J(b)],$=E(L(h((z[0]*Z[0]+z[1]*Z[1])/(F(z[0]*z[0]+z[1]*z[1]+z[2]*z[2])*F(Z[0]*Z[0]+Z[1]*Z[1])),1),-1));0>z[2]&&($=2*K-$),n+=$}if(!O&&('multires'==W||'cubemap'==W)){g=R/2;var _={f:'translate3d(-'+(g+2)+'px, -'+(g+2)+'px, -'+g+'px)',b:'translate3d('+(g+2)+'px, -'+(g+2)+'px, '+g+'px) rotateX(180deg) rotateZ(180deg)',u:'translate3d(-'+(g+2)+'px, -'+g+'px, '+(g+2)+'px) rotateX(270deg)',d:'translate3d(-'+(g+2)+'px, '+g+'px, -'+(g+2)+'px) rotateX(90deg)',l:'translate3d(-'+g+'px, -'+(g+2)+'px, '+(g+2)+'px) rotateX(180deg) rotateY(90deg) rotateZ(180deg)',r:'translate3d('+g+'px, -'+(g+2)+'px, -'+(g+2)+'px) rotateY(270deg)'};e=1/D(c/2);var aa=e*M.clientWidth/2+'px',ca='perspective('+aa+') translateZ('+aa+') rotateX('+a+'rad) rotateY('+b+'rad) ',da=Object.keys(_);for(f=0;6>f;f++){var ea=S.querySelector('.pnlm-'+da[f]+'face');ea&&(ea.style.webkitTransform=ca+_[da[f]],ea.style.transform=ca+_[da[f]])}return}if('multires'!=W){var fa=2*C(D(.5*c)/(O.drawingBufferWidth/O.drawingBufferHeight));e=1/D(.5*fa),O.uniform1f(N.psi,b),O.uniform1f(N.theta,a),O.uniform1f(N.rot,n),O.uniform1f(N.f,e),!0===X&&'equirectangular'==W&&(O.bindTexture(O.TEXTURE_2D,N.texture),O.texImage2D(O.TEXTURE_2D,0,O.RGB,O.RGB,O.UNSIGNED_BYTE,V)),O.drawArrays(O.TRIANGLES,0,6)}else{var ga=t(c,O.drawingBufferWidth/O.drawingBufferHeight,.1,100);v(c);var ha=o();ha=p(ha,-n,'z'),ha=p(ha,-a,'x'),ha=p(ha,b,'y'),ha=q(ha),O.uniformMatrix4fv(N.perspUniform,!1,new Float32Array(r(ga))),O.uniformMatrix4fv(N.cubeUniform,!1,new Float32Array(r(ha)));var ia=w(ga,ha);if(N.nodeCache.sort(j),200<N.nodeCache.length&&N.nodeCache.length>N.currentNodes.length+50)for(var ja=N.nodeCache.splice(200,N.nodeCache.length-200),f=0;f<ja.length;f++)O.deleteTexture(ja[f].texture);N.currentNodes=[];var ka=['f','b','u','d','l','r'];for(g=0;6>g;g++){var la=new m(T[g],ka[g],1,0,0,V.fullpath);i(ia,la,a,b,c)}for(N.currentNodes.sort(k),f=ba.length-1;0<=f;f--)-1===N.currentNodes.indexOf(ba[f].node)&&(ba[f].node.textureLoad=!1,ba.splice(f,1));if(0===ba.length)for(f=0;f<N.currentNodes.length;f++){var ma=N.currentNodes[f];if(!ma.texture&&!ma.textureLoad){ma.textureLoad=!0,setTimeout(u,0,ma);break}}l()}return void 0===d.returnImage?void 0:M.toDataURL('image/png')},this.isLoading=function(){if(O&&'multires'==W)for(var a=0;a<N.currentNodes.length;a++)if(!N.currentNodes[a].textureLoaded)return!0;return!1},this.getCanvas=function(){return M};var ba=[],ca=function(){function a(){var a=this;this.texture=this.callback=null,this.image=new Image,this.image.crossOrigin=d?d:'anonymous';var b=function(){0<a.image.width&&0<a.image.height?(s(a.image,a.texture),a.callback(a.texture,!0)):a.callback(a.texture,!1),c(a)};this.image.addEventListener('load',b),this.image.addEventListener('error',b)}function b(a,b,c,d){this.node=a,this.src=b,this.texture=c,this.callback=d}function c(a){if(ba.length){var b=ba.shift();a.loadTexture(b.src,b.texture,b.callback)}else f[e++]=a}var d,e=4,f={};a.prototype.loadTexture=function(a,b,c){this.texture=b,this.callback=c,this.image.src=a};for(var g=0;g<e;g++)f[g]=new a;return function(a,c,g,h){d=h;var i=O.createTexture();return e?f[--e].loadTexture(c,i,g):ba.push(new b(a,c,i,g)),i}}()}var d='attribute vec2 a_texCoord;varying vec2 v_texCoord;void main() {gl_Position = vec4(a_texCoord, 0.0, 1.0);v_texCoord = a_texCoord;}',e='attribute vec3 a_vertCoord;attribute vec2 a_texCoord;uniform mat4 u_cubeMatrix;uniform mat4 u_perspMatrix;varying mediump vec2 v_texCoord;void main(void) {gl_Position = u_perspMatrix * u_cubeMatrix * vec4(a_vertCoord, 1.0);v_texCoord = a_texCoord;}',f='precision mediump float;\nuniform float u_aspectRatio;\nuniform float u_psi;\nuniform float u_theta;\nuniform float u_f;\nuniform float u_h;\nuniform float u_v;\nuniform float u_vo;\nuniform float u_rot;\nconst float PI = 3.14159265358979323846264;\nuniform sampler2D u_image;\nuniform samplerCube u_imageCube;\nvarying vec2 v_texCoord;\nuniform vec4 u_backgroundColor;\nvoid main() {\nfloat x = v_texCoord.x * u_aspectRatio;\nfloat y = v_texCoord.y;\nfloat sinrot = sin(u_rot);\nfloat cosrot = cos(u_rot);\nfloat rot_x = x * cosrot - y * sinrot;\nfloat rot_y = x * sinrot + y * cosrot;\nfloat sintheta = sin(u_theta);\nfloat costheta = cos(u_theta);\nfloat a = u_f * costheta - rot_y * sintheta;\nfloat root = sqrt(rot_x * rot_x + a * a);\nfloat lambda = atan(rot_x / root, a / root) + u_psi;\nfloat phi = atan((rot_y * costheta + u_f * sintheta) / root);'+'float cosphi = cos(phi);\ngl_FragColor = textureCube(u_imageCube, vec3(cosphi*sin(lambda), sin(phi), cosphi*cos(lambda)));\n}',g='precision mediump float;\nuniform float u_aspectRatio;\nuniform float u_psi;\nuniform float u_theta;\nuniform float u_f;\nuniform float u_h;\nuniform float u_v;\nuniform float u_vo;\nuniform float u_rot;\nconst float PI = 3.14159265358979323846264;\nuniform sampler2D u_image;\nuniform samplerCube u_imageCube;\nvarying vec2 v_texCoord;\nuniform vec4 u_backgroundColor;\nvoid main() {\nfloat x = v_texCoord.x * u_aspectRatio;\nfloat y = v_texCoord.y;\nfloat sinrot = sin(u_rot);\nfloat cosrot = cos(u_rot);\nfloat rot_x = x * cosrot - y * sinrot;\nfloat rot_y = x * sinrot + y * cosrot;\nfloat sintheta = sin(u_theta);\nfloat costheta = cos(u_theta);\nfloat a = u_f * costheta - rot_y * sintheta;\nfloat root = sqrt(rot_x * rot_x + a * a);\nfloat lambda = atan(rot_x / root, a / root) + u_psi;\nfloat phi = atan((rot_y * costheta + u_f * sintheta) / root);'+'lambda = mod(lambda + PI, PI * 2.0) - PI;\nvec2 coord = vec2(lambda / PI, phi / (PI / 2.0));\nif(coord.x < -u_h || coord.x > u_h || coord.y < -u_v + u_vo || coord.y > u_v + u_vo)\ngl_FragColor = u_backgroundColor;\nelse\ngl_FragColor = texture2D(u_image, vec2((coord.x + u_h) / (u_h * 2.0), (-coord.y + u_v + u_vo) / (u_v * 2.0)));\n}',h='varying mediump vec2 v_texCoord;uniform sampler2D u_sampler;void main(void) {gl_FragColor = texture2D(u_sampler, v_texCoord);}';return{renderer:function(a,b,d,e){return new c(a,b,d,e)}}}(window,document);